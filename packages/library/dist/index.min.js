class t{#t;constructor(){this.#t={}}emit(t,e){this.#t[t]&&this.#t[t].forEach((t=>{t(e)}))}on(t,e){this.#t[t]||(this.#t[t]=[]),this.#t[t].push(e)}off(t,e){if(t)if(e||void 0===this.#t[t]){if(void 0!==this.#t[t]&&e instanceof Function){const s=this.#t[t].indexOf(e);s>-1&&this.#t[t].splice(s,1)}}else this.#t[t]=[];else this.#t={}}}function e(t){const e=t.querySelector("title")?.textContent;return null==e?null:e}function s(t){return t instanceof HTMLElement}function n(t){let e;if("number"!=typeof t&&t?.min&&t?.max){e=function(t,e){return Math.random()*(e-t)+t}(t.min,t.max)}else"number"==typeof t&&(e=t);return e}function i(t,e=0){const s=10**e;return Math.round(t*s)/s}class r extends Error{element;animationClass;constructor(t,e,s){super(`${t}\n  class: ${s}`),this.name=this.constructor.name,this.element=e,this.animationClass=s}}function o(t,e){if(Array.isArray(t))for(const s of t)if(s?.animation)e({animation:s.animation});else if(Array.isArray(s?.all))for(const t of s.all)e({animation:t})}async function a(t){const e=t.getAnimations();if(!e.length)return Promise.resolve();const s=e.map((t=>async function(t){return new Promise((e=>{t.addEventListener("finish",(()=>{e()}),{once:!0})}))}(t)));return await Promise.all(s),Promise.resolve()}function l(t){return async function(t){return function(t,e){t.classList.add(e.class),null!=e.duration&&(t.style.setProperty("animation-duration",`${e.duration}ms`),t.style.setProperty("transition-duration",`${e.duration}ms`)),null!=e.delay&&(t.style.setProperty("animation-delay",`${e.delay}ms`),t.style.setProperty("transition-delay",`${e.delay}ms`))}(t.el,t),a(t.el)}(function(t){const e={class:t.class,el:t.el};return t.duration&&(e.duration=i(n(t.duration),3)),t.delay&&(e.delay=i(n(t.delay),3)),e}(t))}class c extends t{process;constructor(t){super(),this.process=t?.process}async#e(t){const e={el:t.el};try{const s=l(t);this.emit("animation-start",e),await s,this.emit("animation-end",e)}catch(e){throw new r(e?.message??e,t.el,t.class)}}async animate(){if(Array.isArray(this.process))for(const t of this.process)if(t?.animation&&s(t?.animation?.el))await this.#e(t.animation);else if(Array.isArray(t?.all)){const e=[];for(const n of t.all)s(n?.el)&&e.push(this.#e(n));await Promise.all(e)}}clearImmediate(){this.process&&o(this.process,(({animation:t})=>{var e,n,i;s(t?.el)&&(n=(e=t).el,i=e.class,n.classList.remove(i),n.style.setProperty("animation-duration",null),n.style.setProperty("animation-delay",null),n.style.setProperty("transition-duration",null),n.style.setProperty("transition-delay",null))}))}}const h=".rt-action-link",u={linkSelector:h,contentSelector:"#rt-content",animation:{elSelector:".rt-el-animation",in:{beforeClass:"rt-el-animation-before-in",class:"rt-el-animation-in"},out:{class:"rt-el-animation-out"}}};class d extends Error{element;selector;constructor(t,e){super("Href not found"),this.name=this.constructor.name,this.element=t,this.selector=e}}class m{#s=[];#n=-1;#i;constructor(t){this.#i=t?.maxLength||3}add(t){this.#s.push(t),this.#n++,this.#s.length>this.#i&&(this.#s.shift(),this.#n--)}get(t){return this.#s.at(t)??null}get current(){return this.#s[this.#n]}get length(){return this.#s.length}backward(){return this.#n<=0?null:(this.#n--,this.#s[this.#n])}forward(){return this.#n>=this.#s.length-1?null:(this.#n++,this.#s[this.#n])}clear(){this.#s=[],this.#n=-1}}class p extends t{linkSelector;#r;#o;#a;constructor(t){super(),this.linkSelector=t?.linkSelector||h,this.#o=this.#l.bind(this),this.#a=this.#c.bind(this),this.#r=new m,this.#r.add(window.location.href)}run(){this.#h()}destroy(){this.#u()}goBack(){const t=this.#r.backward();t&&history.pushState({},"",t)}#h(){document.addEventListener("click",this.#o),window.addEventListener("popstate",this.#a)}#u(){document.removeEventListener("click",this.#o),window.removeEventListener("popstate",this.#a)}#d(t){return!!this.linkSelector&&(!!t&&t.matches(this.linkSelector))}#c(t){this.#m({type:"popstate",nativeEvent:t,toHref:window.location.href,fromHref:this.#r.current})}#m(t){this.#r.add(t.toHref),this.emit("action",t)}#l(t){const e=t.target.closest(this.linkSelector);if(!this.#d(e))return;t.preventDefault();const s=e.getAttribute("href");if(s)history.pushState({},"",s),this.#m({type:"link-click",nativeEvent:t,target:e,toHref:s,fromHref:this.#r.current||window.location.href});else{const t=new d(e,this.linkSelector);this.emit("error",t)}}}class f extends Error{response;constructor(t){super(),this.name=this.constructor.name,this.response=t}}class y extends t{selector;#p;constructor(t){super(),this.selector=t.selector}stop(){this.#p&&this.#p.abort()}async#f(t){const s=await t.text(),n=document.createElement("html");n.innerHTML=s;return{contentElement:n.querySelector(`${this.selector}`),documentTitle:e(n)}}async load(t){try{this.#p=new AbortController;const e=await fetch(t,{signal:this.#p.signal});if(e.ok)return this.#f(e);throw new f(e)}finally{this.#p=null}}}class E extends Error{selector;phase;constructor(t,e){super(`Content not found by selector ${t} in phase ${e}`),this.name=this.constructor.name,this.selector=t,this.phase=e}}function b(t){return null!=t&&"Object"===t?.constructor?.name}function w(t){if(Array.isArray(t))return[...t];if(!b(t))return t;const e={};return Object.keys(t).forEach((s=>{e[s]=w(t?.[s])})),e}function A(t,e){if(!b(t))return;Object.keys(e).forEach((s=>{s in t?b(e[s])&&A(t[s],e[s]):t[s]=e[s]}))}function g(t){const e=w(t??{});return A(e,u),e}function k(t,e){return{el:t.el,class:t.class??e.class,duration:t.duration??e.duration,delay:t.delay??e.delay}}function C(t,e){const s=[];return t.forEach((t=>{if(t?.animation){const n=k(t.animation,e);s.push({animation:n})}else if(Array.isArray(t?.all)){const n=[];t.all.forEach((t=>{const s=k(t,e);n.push(s)})),s.push({all:n})}})),s}class L extends t{options;#y;#E;#b;#w;#A;#g;#k;constructor(t){super(),this.options=g(t),this.#E=new p({linkSelector:this.options.linkSelector}),this.#b=new y({selector:this.options.contentSelector}),this.#w=new c}run(){this.#E.run(),this.#E.on("action",this.#C),this.#E.on("error",this.#L),this.#w.on("animation-start",this.#P)}destroy(){this.#E.off(),this.#E.destroy(),this.#b.off(),this.#w.off()}setProcess(t){Array.isArray(t)?this.#y=C(t,this.options.animation[this.#A]):this.#y=null}getPhase(){return this.#A}#x(){this.#g=document.querySelector(this.options.contentSelector)}#v(){return[...document.querySelectorAll(`${this.options.animation.elSelector}`)]}#S(t){return function({els:t,options:e,phase:s}){const n=[],i=[];return t.forEach((t=>{const n={el:t,class:e.animation[s].class,duration:e.animation[s].duration,delay:e.animation[s].delay};i.push(n)})),n.push({all:i}),n}({els:t,options:this.options,phase:this.#A})}#H(t){t.classList.add(this.options.animation.in.beforeClass)}#B(t){t.classList.remove(this.options.animation.in.beforeClass)}#P=t=>{s(t?.el)&&this.#B(t.el)};async#O(t){return this.#k&&this.#b.stop(),this.#b.load(t.toHref).then((t=>{if(!s(t.contentElement))throw new E(this.options.contentSelector,"in");return this.emit("load",t),t}))}#I(t){var e;this.#$(t.contentElement?.outerHTML),this.emit("insert",t),null!=t.documentTitle&&(e=t.documentTitle,document.title=e)}#$(t){this.#g.outerHTML=t}#R(){if(this.#x(),!this.#g)throw new E(this.options.contentSelector,"out");const t=this.#v();return{contentEl:this.#g,animatedEls:t}}#T({phase:t,els:e}){Array.isArray(this.#y)?this.#y=C(this.#y,this.options.animation[t]):this.#y=this.#S(e),this.#w.process=this.#y}async#M(){return this.#w.animate()}async#j(t){this.#A=t;const{animatedEls:e}=this.#R();this.emit("process",{animatedEls:e,phase:this.#A}),"in"===t&&this.#q(),this.#T({phase:t,els:e}),await this.#M(),this.#y=null}async#D(){await this.#j("in"),this.#w.clearImmediate()}async#F(){await this.#j("out")}#q(){this.#y&&o(this.#y,(({animation:t})=>{s(t?.el)&&this.#H(t.el)}))}async#z(t){const e=await Promise.allSettled([this.#O(t),this.#F()]);if("rejected"===e[0].status)throw e[0].reason;if("rejected"===e[1].status)throw e[1].reason;return e[0].value}#G(t){this.emit("error",t)}#L=t=>{this.#k||(this.#G(t),this.#k=!1)};#J(t){this.#G(t),t instanceof f&&404===t.response?.status&&this.#E.goBack(),location.reload()}#C=async t=>{if(!this.#k)try{this.#k=!0,this.emit("action",t);const e=await this.#z(t);this.#I(e),await this.#D(),this.emit("complete")}catch(t){this.#J(t)}finally{this.#k=!1}}}export{r as AnimationError,E as ContentElementNotFoundError,d as HrefNotFoundError,f as RequestError,L as default};
